<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evolution Patcher Robust v1.3</title>
    <style>
        :root {
            --primary: #ff4081;
            --bg: #fff;
            --text: #333;
            --log-bg: #1e1e1e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 15px; 
            font-size: 16px;
        }
        .container { width: 100%; max-width: 600px; margin: 0 auto; }
        h1 { 
            color: var(--primary); text-align: center; 
            font-size: 1.4rem; margin: 10px 0; 
        }
        .step { 
            margin-bottom: 15px; padding: 15px; 
            background: #fdf2f8; border-radius: 12px; 
            border: 1px solid #fbcfe8;
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .step-title { 
            font-weight: bold; color: #be185d; font-size: 0.9rem; 
        }
        .clear-btn {
            background: #f472b6; color: white; border: none;
            padding: 4px 12px; border-radius: 6px; font-size: 0.75rem;
            cursor: pointer; font-weight: bold;
        }
        .clear-btn:active { background: #db2777; }
        
        textarea, input[type="file"] { 
            width: 100%; border: 1px solid #f9a8d4; border-radius: 8px; 
            padding: 12px; font-family: monospace; font-size: 14px; 
            background: white;
        }
        textarea { height: 120px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { 
            background: var(--primary); color: white; border: none; 
            padding: 16px; border-radius: 12px; cursor: pointer; 
            width: 100%; font-size: 1rem; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(255, 64, 129, 0.3);
            transition: transform 0.1s;
        }
        .btn.secondary { background: #6366f1; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        .log { 
            margin-top: 15px; padding: 15px; background: var(--log-bg); 
            color: #d4d4d4; border-radius: 10px; font-family: monospace; 
            font-size: 11px; overflow-x: auto; white-space: pre-wrap; 
            min-height: 80px; max-height: 200px;
        }
        .success { color: #4ade80; }
        .error { color: #fb7185; font-weight: bold; }
        .warning { color: #fbbf24; }
        
        #result-actions { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üíñ Evolution Patcher <small>Robust v1.3</small></h1>
    <p style="font-size: 0.7rem; text-align: center; color: #999; margin-top: -10px;">For LoveLive! OCG Simulator Development</p>

    <div class="step">
        <label class="step-title">1. ÂØæË±°„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
        <input type="file" id="fileInput" accept=".js, .html, .css, text/javascript, text/plain">
    </div>

    <div class="step">
        <div class="step-header">
            <label class="step-title">2. „Éë„ÉÉ„ÉÅ(JSON)„ÇíË≤º„Çä‰ªò„Åë</label>
            <button class="clear-btn" onclick="clearPatch()">„ÇØ„É™„Ç¢</button>
        </div>
        <textarea id="patchInput" placeholder='[{"action": "replace_text", "target": "old", "code": "new"}]' spellcheck="false"></textarea>
    </div>

    <button class="btn" onclick="processPatch()">„Éë„ÉÉ„ÉÅ„ÇíÈÅ©Áî®„Åô„Çã</button>

    <div id="result-actions">
        <div class="btn-group">
            <button class="btn secondary" onclick="downloadFile()">„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò</button>
            <button class="btn secondary" onclick="copyToClipboard()">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
        </div>
    </div>

    <div id="log" class="log">„É≠„Ç∞: ÂæÖÊ©ü‰∏≠...</div>
</div>

<script>
    let patchedContent = "";
    let targetFileName = "";
    const logEl = document.getElementById('log');

    /**
     * ÊñáÂ≠óÂàó„ÅÆÊ≠£Ë¶èÂåñ
     * 1. ÊîπË°å„Ç≥„Éº„Éâ„Çí \n „Å´Áµ±‰∏Ä
     * 2. Ë°åÊú´„ÅÆÁÑ°ÈßÑ„Å™„Çπ„Éö„Éº„Çπ„Éª„Çø„Éñ„ÇíÂâäÈô§
     */
    function normalizeContent(str) {
        if (!str) return "";
        return str
            .replace(/\r\n|\r/g, "\n")      // ÊîπË°åÁµ±‰∏Ä
            .replace(/[ \t]+$/gm, "");      // Ë°åÊú´„Çπ„Éö„Éº„ÇπÂâäÈô§
    }

    function addLog(msg, type = '') {
        const div = document.createElement('div');
        div.className = type;
        div.textContent = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function clearPatch() {
        document.getElementById('patchInput').value = '';
        addLog("„Éë„ÉÉ„ÉÅÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ");
    }

    async function processPatch() {
        logEl.innerHTML = '';
        const fileInput = document.getElementById('fileInput');
        const fileFile = fileInput.files[0];
        const patchText = document.getElementById('patchInput').value;

        if (!fileInput.files.length || !patchText.trim()) {
            addLog("„Éï„Ç°„Ç§„É´„Å®„Éë„ÉÉ„ÉÅ„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "error");
            return;
        }

        try {
            const patches = JSON.parse(patchText);
            addLog(`${fileFile.name} Ë™≠„ÅøËæº„ÅøÈñãÂßã...`);

            const reader = new FileReader();
            reader.onload = () => {
                // ÂÖÉ„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíÊ≠£Ë¶èÂåñ
                let content = normalizeContent(reader.result);
                let successCount = 0;

                for (let i = 0; i < patches.length; i++) {
                    const p = patches[i];
                    const patchId = `P#${i + 1}`;

                    if (p.action === 'replace_text') {
                        // „Éë„ÉÉ„ÉÅÂÅ¥„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Ç≥„Éº„Éâ„ÇÇÊ≠£Ë¶èÂåñ„Åó„Å¶ÊØîËºÉ
                        const normalizedTarget = normalizeContent(p.target);
                        const normalizedReplacement = normalizeContent(p.code);

                        if (content.includes(normalizedTarget)) {
                            // split().join() „Å´„Çà„ÇãÂé≥ÂØÜ„Åã„Å§ÂÖ®ÁΩÆÊèõ
                            content = content.split(normalizedTarget).join(normalizedReplacement);
                            addLog(`${patchId}: ÁΩÆÊèõÊàêÂäü`, "success");
                            successCount++;
                        } else {
                            addLog(`${patchId}: Â§±Êïó(Target‰∏ç‰∏ÄËá¥)`, "error");
                            addLog("‚ÄªÊîπË°å„Å®Ë°åÊú´„Çπ„Éö„Éº„Çπ„ÅØÊ≠£Ë¶èÂåñÊ∏à„Åø„Åß„Åô„ÄÇ„Ç≥„Éº„ÉâËá™‰Ωì„ÅÆÂ∑ÆÁï∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "warning");
                            return; // ‰∏Ä„Å§„Åß„ÇÇÂ§±Êïó„Åó„Åü„ÇâÂÅúÊ≠¢
                        }
                    } else if (p.action === 'append') {
                        const normalizedAppend = normalizeContent(p.code);
                        content = content.trimEnd() + "\n" + normalizedAppend;
                        addLog(`${patchId}: Êú´Â∞æËøΩÂä†ÂÆå‰∫Ü`, "success");
                        successCount++;
                    }
                }

                patchedContent = content;
                targetFileName = fileFile.name;
                document.getElementById('result-actions').style.display = "block";
                addLog(`ÂÆå‰∫ÜÔºÅ ${successCount}‰ª∂„ÅÆ„Éë„ÉÉ„ÉÅ„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü„ÄÇ`, "success");
            };
            reader.readAsText(fileFile);

        } catch (e) {
            addLog("JSONËß£Êûê„Ç®„É©„Éº: " + e.message, "error");
            addLog("„Éë„ÉÉ„ÉÅ„ÅåÊ≠£„Åó„ÅÑJSONÂΩ¢Âºè [{}, {}] „Åß„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "warning");
        }
    }

    function downloadFile() {
        if (!patchedContent) return;
        const blob = new Blob([patchedContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = targetFileName;
        a.click();
        URL.revokeObjectURL(url);
    }

    async function copyToClipboard() {
        if (!patchedContent) return;
        try {
            await navigator.clipboard.writeText(patchedContent);
            addLog("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ", "success");
        } catch (err) {
            addLog("„Ç≥„Éî„ÉºÂ§±Êïó: " + err, "error");
        }
    }
</script>

</body>
</html>
